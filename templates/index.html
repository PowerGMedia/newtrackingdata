<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fleet Lookup</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #f0f0f0;
            padding: 20px;
        }
        input[type="text"] {
            padding: 8px;
            width: 250px;
            border-radius: 5px;
        }
        button {
            padding: 8px 12px;
            margin-left: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        #result {
            margin-top: 20px;
            border-top: 1px solid #444;
            padding-top: 20px;
        }
        #changeForm {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }
        textarea {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: none;
        }
    </style>
</head>
<body>

    <h1>Fleet Lookup</h1>
    <input type="text" id="fleetNumber" placeholder="Enter fleet number or reg">
    <button onclick="searchFleet()">Search</button>

    <div id="result"></div>

    <div id="changeForm" style="display:none;">
        <h2>Request a Change</h2>
        <textarea id="changeNotes" rows="5" placeholder="Explain the change request here..."></textarea><br><br>
        <button onclick="submitChangeRequest()">Submit Request</button>
    </div>

    <script>
        let fleetDatabase = [];
        let selectedFleetForChange = null;

        async function fetchFleetData() {
            const res = await fetch("/fleet");
            return res.json();
        }

        async function searchFleet() {
            const input = document.getElementById("fleetNumber").value.trim();
            const resultDiv = document.getElementById("result");
            const changeForm = document.getElementById("changeForm");
            resultDiv.innerHTML = "";
            changeForm.style.display = "none";

            if (!input) return;

            const data = await fetchFleetData();
            fleetDatabase = data;

            const matches = fleetDatabase.filter(item =>
                item.fleetNumber.toLowerCase() === input.toLowerCase() ||
                item.reg.toLowerCase() === input.toLowerCase()
            );

            if (matches.length === 0) {
                resultDiv.innerHTML = `<p>No matching record found.</p>`;
                return;
            }

            const fleet = matches[0];
            selectedFleetForChange = fleet;

            resultDiv.innerHTML = `
                <p><strong>Fleet Number:</strong> ${fleet.fleetNumber}</p>
                <p><strong>Reg:</strong> ${fleet.reg}</p>
                <p><strong>Previous Reg:</strong> ${fleet.previousReg}</p>
                <p><strong>Vehicle Type:</strong> ${fleet.vehicleType}</p>
                <p><strong>Livery:</strong> ${fleet.livery}</p>
                <p><strong>Operator:</strong> ${fleet.operator}</p>
            `;

            changeForm.style.display = "block";
        }

        async function submitChangeRequest() {
            const notes = document.getElementById("changeNotes").value.trim();
            if (!notes) {
                alert("Please enter your change request notes.");
                return;
            }

            const response = await fetch("/request_change", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    fleet: selectedFleetForChange,
                    notes: notes
                })
            });

            const data = await response.json();
            if (data.success) {
                alert("Change request submitted successfully!");
                document.getElementById("changeNotes").value = "";
                document.getElementById("changeForm").style.display = "none";
            } else {
                alert("Failed to submit change request: " + (data.error || "unknown error"));
            }
        }
    </script>

</body>
</html>
